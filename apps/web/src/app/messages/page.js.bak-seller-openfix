"use client";
import { useEffect, useState } from "react";
import Link from "next/link";
import { apiGet, apiPost } from "@/lib/api";

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

export default function MessagesInbox() {
  const [items, setItems] = useState([]);
  const [err, setErr] = useState("");
  const [busyId, setBusyId] = useState("");

  // Notifications banner state
  const [showNotifBanner, setShowNotifBanner] = useState(false);
  const [notifBusy, setNotifBusy] = useState(false);
  const [notifErr, setNotifErr] = useState("");

  async function load() {
    setErr("");
    try {
      const r = await apiGet("/api/messages/inbox");
      setItems(r.items || []);
    } catch (e) {
      setErr(String(e.message || e));
    }
  }

  async function openThread(adId, rowId) {
    setErr("");
    setBusyId(String(rowId));
    try {
      const r = await apiPost("/api/messages/open", { ad_id: Number(adId) });
      const tid = r?.thread_id;
      if (!tid) throw new Error("OPEN_THREAD_FAILED");
      window.location.href = `/messages/thread/${tid}?ts=${Date.now()}`;
    } catch (e) {
      const m = String(e.message || e);
      setErr(m);
      alert("ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: " + m);
    } finally {
      setBusyId("");
    }
  }

  async function enableNotifications() {
    setNotifErr("");
    setNotifBusy(true);
    try {
      if (typeof window === "undefined") throw new Error("NO_WINDOW");
      if (!("Notification" in window)) throw new Error("NOT_SUPPORTED");
      if (!("serviceWorker" in navigator)) throw new Error("NO_SW");
      if (!("PushManager" in window)) throw new Error("NO_PUSH");

      // Must be user-initiated (button click)
      const perm = await Notification.requestPermission();
      if (perm !== "granted") {
        setShowNotifBanner(false);
        return;
      }

      const reg = await navigator.serviceWorker.register("/sw.js");

      const k = await apiGet("/api/push/vapid-public-key");
      const publicKey = k?.publicKey;
      if (!publicKey) throw new Error("MISSING_VAPID_PUBLIC_KEY");

      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey),
        });
      }

      // Send subscription to server
      const payload = sub.toJSON ? sub.toJSON() : sub;
      await apiPost("/api/push/subscribe", payload);

      setShowNotifBanner(false);
    } catch (e) {
      setNotifErr(String(e.message || e));
    } finally {
      setNotifBusy(false);
    }
  }

  useEffect(() => {
    load();

    // Show banner only when it makes sense (no auto permission prompt)
    try {
      if (typeof window === "undefined") return;
      const supported =
        "Notification" in window &&
        "serviceWorker" in navigator &&
        "PushManager" in window;

      if (!supported) return;

      if (Notification.permission === "default") {
        setShowNotifBanner(true);
      }
    } catch {}
  }, []);

  return (
    <div>
      <div className="row" style={{ marginBottom: 12 }}>
        <h1 style={{ margin: 0, fontSize: 22, fontWeight: 900 }}>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h1>
        <Link className="btn" href="/">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</Link>
      </div>

      {showNotifBanner ? (
        <div className="card" style={{ marginBottom: 12 }}>
          <div className="card-body" style={{ display: "flex", flexDirection: "column", gap: 10 }}>
            <div style={{ fontWeight: 900 }}>ğŸ”” Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø´Ø¹Ø§Ø±Ù‹Ø§ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ</div>
            <div className="muted">
              Ù„ØªØ¹Ø±Ù ÙÙˆØ±Ù‹Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ø´ØªØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ¶ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.
            </div>

            {notifErr ? (
              <div className="muted" style={{ color: "var(--danger)", fontWeight: 900 }}>
                ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„: {notifErr}
              </div>
            ) : null}

            <div style={{ display: "flex", gap: 8, justifyContent: "flex-start", flexWrap: "wrap" }}>
              <button className="btn" onClick={enableNotifications} disabled={notifBusy}>
                {notifBusy ? "Ø¬Ø§Ø±Ù Ø§Ù„ØªÙØ¹ÙŠÙ„..." : "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"}
              </button>
              <button className="btn" onClick={() => setShowNotifBanner(false)} disabled={notifBusy}>
                Ù„Ø§Ø­Ù‚Ù‹Ø§
              </button>
              <Link className="btn" href="/notifications">
                ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
              </Link>
            </div>
          </div>
        </div>
      ) : null}

      {err ? (
        <div className="card">
          <div className="card-body">Error: {err}</div>
        </div>
      ) : null}

      <div className="card">
        <div className="card-body" style={{ display: "flex", flexDirection: "column", gap: 10 }}>
          {items.length === 0 ? (
            <div className="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯.</div>
          ) : (
            items.map((t) => (
              <button
                key={t.id}
                className="card"
                onClick={() => openThread(t.ad_id, t.id)}
                style={{ textAlign: "right", cursor: "pointer" }}
              >
                <div className="card-body" style={{ display: "flex", gap: 12, alignItems: "center" }}>
                  <div
                    style={{
                      width: 56,
                      height: 56,
                      borderRadius: 12,
                      overflow: "hidden",
                      border: "1px solid var(--border)",
                      background: "rgba(0,0,0,.04)",
                      flex: "0 0 auto",
                    }}
                  >
                    {t.ad_image ? (
                      <img
                        src={t.ad_image}
                        alt="thumb"
                        style={{ width: "100%", height: "100%", objectFit: "cover", display: "block" }}
                      />
                    ) : (
                      <div
                        style={{
                          width: "100%",
                          height: "100%",
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "center",
                        }}
                        className="muted"
                      >
                        â€”
                      </div>
                    )}
                  </div>

                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ fontWeight: 900 }} className="ellipsis">
                      {t.ad_title || "Ø¥Ø¹Ù„Ø§Ù†"}
                    </div>
                    <div className="muted" style={{ marginTop: 4 }}>
                      {t.seller_name} {t.seller_is_verified ? "âœ…" : ""}
                    </div>
                    <div className="muted" style={{ fontSize: 12, marginTop: 6 }}>
                      Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©: {new Date(t.last_message_at).toLocaleString("ar")}
                    </div>
                  </div>

                  {busyId === String(t.id) ? (
                    <div className="muted" style={{ fontSize: 12, fontWeight: 900 }}>
                      ...
                    </div>
                  ) : null}
                </div>
              </button>
            ))
          )}

          <div style={{ height: 6 }} />
          <button className="btn" onClick={load}>
            ØªØ­Ø¯ÙŠØ«
          </button>
        </div>
      </div>
    </div>
  );
}
