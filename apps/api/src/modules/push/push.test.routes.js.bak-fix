import { Router } from "express";
import { sendPushToGuest, isPushReady } from "./push.service.js";

export const pushTestRouter = Router();

function getGuestId(req) {
  return (req.headers["x-guest-id"] || "").toString().trim();
}

pushTestRouter.post("/push/test", async (req, res) => {
  const guestId = getGuestId(req);
  if (!guestId) return res.status(400).json({ ok: false, error: "MISSING_GUEST_ID" });
  if (!isPushReady()) return res.status(400).json({ ok: false, error: "PUSH_NOT_READY" });

  const r = await sendPushToGuest({
      guestId,
      payload: { title: "Souq Syria", body: "اختبار إشعار ✅", url: "/messages" }
    });

    if (!r) return res.status(500).json({ ok: false, error: "PUSH_SEND_FAILED" });

    if (!r.ok) {
      const code = r.error || "SEND_FAILED";
      return res.status(400).json({ ok: false, error: code });
    }

    res.json({ ok: true, sent: r.sent });
});
