import crypto from "crypto";

function parseCookie(header) {
  const out = {};
  if (!header) return out;
  const parts = header.split(";");
  for (const p of parts) {
    const i = p.indexOf("=");
    if (i === -1) continue;
    const k = p.slice(0, i).trim();
    const v = p.slice(i + 1).trim();
    out[k] = decodeURIComponent(v);
  }
  return out;
}

export function guestMiddleware(req, res, next) {
  const cookies = parseCookie(req.headers.cookie || "");
  let guestId = (cookies.guest_id || "").toString().trim();
  if (!guestId) guestId = (req.headers["x-guest-id"] || "").toString().trim();

  if (!guestId || guestId.length < 8) {
    guestId = crypto.randomBytes(16).toString("hex");

    // IMPORTANT: SameSite=Lax works with normal navigation and fetch on same-site.
    // If you ever move API to different subdomain, you'll need SameSite=None; Secure.
    res.setHeader("Set-Cookie", `guest_id=${encodeURIComponent(guestId)}; Path=/; HttpOnly; SameSite=Lax; Max-Age=31536000`);
  }

  req.guest_id = guestId;
  next();
}
